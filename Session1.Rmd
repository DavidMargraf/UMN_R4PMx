---
title: 'Session 1: Data Assembly'
author: "Samuel P Callisto"
date: "June 7, 2018"
output: html_document
---

## Using R Markdown
Useful resource: R Markdown Cheatsheet
https://www.rstudio.com/resources/cheatsheets/

### Output in LaTeX
Surrounding \\theta_{ij} with "\$" will generate $\theta_{ij}$

### Useful keyboard shortcuts
Ctrl-Alt-I: Insert new chunk

Ctrl-Enter: Run current line of code (multiple if highlighted)

Ctrl-Shift-C: Comment/uncomment selected lines

### Importing data
```{r, include = F}
## install packages if necessary
if(!(c("devtools","tidyverse") %in% installed.packages()[,"Package"])) install.packages(c("devtools", "tidyverse"))
if(!("dataTools" %in% installed.packages()[,"Package"])) devtools::install_github("callistosp/dataTools")
```
```{r, warning=F, message=F}
## load packages
library(dataTools)
library(tidyverse)

## Excel files
excel <- read.csv("datasets/TPM_sim_dataset_20180607.csv", as.is = T, stringsAsFactors = T, header = T)
```
Can also use file.choose() or absolute filepath (instead of relative to working directory) to select files you want to import.

### Arguments to modify output
  include, warning, message, etc.

I always import ALL datasets and packages in my first chunk of code. This way you don't need to hunt down the line where data was imported, just re-run the first chunk.

\newpage

## Data types in R
There are multiple ways to represent data in R. Most of the time we work with numbers, and R uses different names for different types of numbers:

	integer or int: any whole number.
	
	numeric or num: numbers with a decimal. Also called double.

When we are working with text, there are multiple ways to represent them in R as well:

	character or chr: basic representation of a string
	
	Factor: Râ€™s representation of an enumerated data type (set of named levels)

Most of the time we want to work with text as a character because they are easier to manipulate. Numbers can also be treated as a character, but this is typically undesirable because we cannot perform any arithmetic manipulations on numbers when they are in this format.
```{r}
var <- 3
str(var)
var*2

var.c <- as.character(var)
str(var.c)
```


A third data type is the logical (or boolean) type (TRUE or T, FALSE or F). These are typically generated using logical tests
```{r}
vec.1 <- c(1:5)
str(vec.1)

vec.2 <- c("a", "b", "c", "d", "e")
str(vec.2)

vec.3 <- c(TRUE,FALSE,F,F,T)
str(vec.3)

df <- data.frame(vec.1, vec.2, vec.3)
names(df) <- c("numbers", "letters", "vowels")

str(df)
```


\newpage

## Some comments about reproducibility
### The importance of readability
A bad example of readability
```{r}
write.csv(headr("datasets/TPM_sim_dataset_20180607.csv") %>%
  select(subjectid) %>% 
  left_join(headr("datasets/Baseline_sim_dataset_AllSubjects_20180607.csv"),
            by= "subjectid"), "datasets/output.csv", row.names = F)
```
Can anyone guess what this line of code is accomplishing?

A good example of readability
```{r}
## import data
baselineData <- headr("datasets/Baseline_sim_dataset_AllSubjects_20180607.csv")
topiramateData <- headr("datasets/TPM_sim_dataset_20180607.csv")

## create completers subset from topiramateData
completers <- select(topiramateData, subjectid)

## filter to keep only completers
filteredBaseline <- left_join(completers, baselineData, by= "subjectid")

## save filteredBaseline
write.csv(filteredBaseline, "datasets/Baseline_sim_dataset_CompletersOnly_20180607.csv", row.names = F)
```
Tip: Use "camel case" to separate words within a variable name by capitalizing the first letter of a new word, e.g. baselineData. This applies not only to coding within R, but also maintaining a proper audit trail for all your files!

Naming convention: for version control, best method of including dates is to use yyyymmdd, as this will sort chronologically when sorted alphabetically


### Always write your code as though it were being read by a human, not a computer!
In addition to liberal commenting throughout your code, do not underestimate the importance of creating descriptive variable names. If a future graduate student takes over your project after you've graduated, will they be able to decipher what your code does without calling you to ask?

\newpage

## Function Writing

### A trivial example
```{r}
sumMinusOne <- function(x){
  output <- 0
  for(i in 1:length(x)){
    output <- output + x[i]
  }
  return(output-1)
}

sumMinusOne(2:4)
```

## When would I ever use this?

### Example 1: Wrapper function
Problem: importing files with multiple headers causes the data type to be interpretted incorrectly, causing resulting in manual typecasting for multiple rows (annoying!)
```{r, warning=F}
## dataset imported using read.csv()
str(excel)
excel$subjectid <- as.integer(excel$subjectid)
excel$var3 <- as.double(excel$var3)
```
Solution: write a wrapper function that assigns correct header row while maintaining data types.
```{r}
headr <- function(file, header.row=1, data.start=3){
  headers <- read.csv(file = file, skip=header.row-1, header = F, nrows = 1, as.is = T)
  dataset <- read.csv(file=file, skip = data.start-1, header = F, as.is=T)
  names(dataset) <- headers
  return(dataset)
}

## dataset imported using headr()
str(topiramateData)
```
Notice how few arguments need to be filled out manually each time you import a file using the helper function since you are allowed to set your defaults.

### Example 2: Dealing with Times
Problem: RedCap stores my times as a character string ("6:45"), but I want to calculate the difference between observations.

Solution: write a function to use this time and the next time you encounter clock times
```{r}
numericTime <- function(vec){
  ## separate hours and minutes into a vector
  sapply(strsplit(vec,":"),
         function(x) {
           ## convert to numeric type to allow arithmetic operations
           x <- as.numeric(x)
           ## numeric time = hours + (minutes/60) rounded to two decimals
           round(x[1]+x[2]/60,2)
         }
  )
}

topiramateData$TIME <- numericTime(topiramateData$var2)
```

## A general rule of thumb:
If you find yourself copying code within or between files, you should probably just write a function. Better still, add functions to a personal R package that you can easily import and share.

### Great resource for learning more about writing functions
http://adv-r.had.co.nz/Functional-programming.html

\newpage

## Version control
### What's that mean?
Everytime you modify a file, you have created a new "version" of it. Version control allows you to keep a record of all the changes that you have made to a file. This way if you break a script that you have written, you can easily go back to the old version.

### GitHub glossary

Commit

Push

Pull 

Fork

Branch


### Repositories
Can be either public or private. On github.com with a free account you can ONLY create public repositories. These can be seen by anyone. Enterprise or paid version of GitHub allows you to create private repositories which can only be seen by you and collaborators of your choice.

### UMN GitHub
Students have free access to an Enterprise version of GitHub through UMN. Allows users to have private repositories. Users outside UMN cannot see anything in this account, but you can transfer repositories from the UMN GitHub to a public GitHub account.

